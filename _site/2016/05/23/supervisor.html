<!--
     created by shibo, 2015-04-23 19:23:32.
     Copyright (c) qii404@126.com All Rights Reserved.
     代码何苦为难码农...

                 #####################################################
                 #                                                   #
                 #                       _oo0oo_                     #
                 #                      o8888888o                    #
                 #                      88" . "88                    #
                 #                      (| -_- |)                    #
                 #                      0\  =  /0                    #
                 #                    ___/`---'\___                  #
                 #                  .' \\|     |# '.                 #
                 #                 / \\|||  :  |||# \                #
                 #                / _||||| -:- |||||- \              #
                 #               |   | \\\  -  #/ |   |              #
                 #               | \_|  ''\---/''  |_/ |             #
                 #               \  .-\__  '-'  ___/-. /             #
                 #             ___'. .'  /--.--\  `. .'___           #
                 #          ."" '<  `.___\_<|>_/___.' >' "".         #
                 #         | | :  `- \`.;`\ _ /`;.`/ - ` : | |       #
                 #         \  \ `_.   \_ __\ /__ _/   .-` /  /       #
                 #     =====`-.____`.___ \_____/___.-`___.-'=====    #
                 #                       `=---='                     #
                 #     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~   #
                 #                                                   #
                 #               佛祖保佑         永无BUG              #
                 #                                                   #
                 #####################################################
 -->


<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name=viewport content="width=device-width, initial-scale=1">

    <meta name="keywords" content="supervisor, 进程管理， linux进程控制">
    <meta name="description" content="Linux、Mac环境下使用 Supervisor 管理进程，守护进程运行">

    <meta name="author" content="齐士博">

    <meta property="og:title" content="Supervisor 进程管理" />
    <meta property="og:type" content="IT Blog" />

    <link rel="shortcut icon" href="/assets/img/icon48.ico">

    <link rel="stylesheet" type="text/css" href="https://cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.bootcss.com/font-awesome/4.2.0/css/font-awesome.min.css">

    

    <title>Supervisor 进程管理</title>

    <style type="text/css">
        .container{
            max-width: 1050px;
        }
        .qii-navbar{
            margin-bottom: 0;
            border-radius: 0;
        }

        .qii-navbar .qii-icon-container{
            width: 53px;
        }

        .qii-navbar .qii-icon-container img{
            margin-top: -8px;
        }

        .container .qii-post-content img{
            width: 80%;
            max-width: 100%;
            margin-top: 8px;
            margin-bottom: 25px;
            border-radius: 8px;
            border:2px solid lightgrey;
        }
        .container .qii-post-content h2,
        .container .qii-post-content h3,
        .container .qii-post-content h4{
            margin-top: 40px;
        }
        table {
            width: 100%;
            max-width: 65em;
            border: 1px solid #dedede;
            margin: 15px auto;
            border-collapse: collapse;
            empty-cells: show;
        }

        table th,
        table td {
          height: 35px;
          border: 1px solid #dedede;
          padding: 0 10px;
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-default navbar-inverse-- qii-navbar ">
        <div class="container">

            <div class="navbar-header">
                <div class="qii-icon-container">
                    <a id="qii-icon-a" class="navbar-brand" href="/"></a>
                </div>

                <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#qii-navbar-collapse" aria-controls="bs-navbar" aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="navbar-collapse collapse" id="qii-navbar-collapse">
                <ul class="nav navbar-nav">
                    <li name="home"><a href="/">Home <span class="sr-only">(current)</span></a></li>
                    <li name="github"><a href="https://github.com/qishibo/" target="blank">Github</a></li>
                    <li name="weibo"><a href="http://weibo.com/shiboooo?profile_ftype=1&is_hot=1" target="blank">Weibo</a></li>
                    <li name="about"><a href="/about">About</a></li>
                </ul>

                <!-- <form class="navbar-form navbar-right" role="search">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search Google">
                    </div>
                    <button type="submit" class="btn btn-default">Search</button>
                </form> -->

            </div>
        </div>
    </nav>

<style type="text/css">
    .qii-top-desc .jumbotron{
        color: white;

        background-image: -webkit-gradient(linear,left top,left bottom,from(#563d7c),to(#6f5499));
        background-image: -webkit-linear-gradient(top,#563d7c 0,#6f5499 100%);
        background-image: -o-linear-gradient(top,#563d7c 0,#6f5499 100%);
        background-image: linear-gradient(to bottom,#563d7c 0,#6f5499 100%);
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#563d7c', endColorstr='#6F5499', GradientType=0);
        background-repeat: repeat-x;

        padding: 30px 0;
    }

    .qii-top-desc .post-title{
        margin-right: 20%;
    }
    .qii-top-desc .post-desc{
        font-size: 22px;
        font-weight: 300;
        margin-right: 20%;
        color: #cdbfe3;
        text-shadow: 0 1px 0 rgba(0,0,0,.1);
    }
    .qii-top-desc .post-date{
        color: #e3ddec;
    }


    .qii-post-content{
        min-height: 45%;
        font-size: 125%;
        line-height: 1.6;
    }
</style>

<header class="qii-top-desc">
    <div class="jumbotron">
        <div class="container">
            <h2 class="post-title">Supervisor 进程管理</h2>
            <p class="post-desc">Linux、Mac环境下使用 Supervisor 管理进程，守护进程运行</p>
            
            <span class="post-date">
                <i class="fa fa-calendar" aria-hidden="true"></i>
                <!-- <span class="glyphicon glyphicon-calendar" aria-hidden="true"></span> -->
                <span>2016-05-23</span>
            </span>
            
        </div>
    </div>
</header>

<!-- content -->
<div class="container">

    <div class="row">
        <div class="col-md-10">
            <div class="qii-post-content">
                <p>使用Linux、 Mac系统的同学们一定遇到过这样的问题：我要打开一个进程，或者说跑一个脚本，但是呢，这个脚本有些不稳定，时不时的抽一下风，自己可能就会挂掉了，然后我要手动重启。当然一次两次我手动重启还是可以接受的，但当我要启动的这个程序要作为Service服务运行的时候，那么我就必须得一直得ps看着他还在不在，不在了就得人工参与启动服务。</p>

<p>这样的日子过够了之后，一些聪明的程序猿可能就会想一些法子了，比如自己写一个daemon守护进程，一直ps盯着程序是否还在，如果不在就启动，否则不处理。类似下面的shell脚本，通过crontab的方式定时检测</p>

<div class="language-shell highlighter-rouge"><pre class="codehilite"><code><span class="nv">exists</span><span class="o">=</span><span class="sb">`</span>ps ux |grep <span class="s1">'program.xxx'</span><span class="sb">`</span>

<span class="k">if</span> <span class="o">[</span><span class="nv">$exists</span> <span class="o">=</span> <span class="s1">''</span> <span class="o">]</span>;<span class="k">then
    </span><span class="nb">echo</span> <span class="s1">'not running'</span>
    run program
<span class="k">else
    </span><span class="nb">echo</span> <span class="s1">'running, exit'</span>
<span class="k">fi</span>
</code></pre></div>

<p>上面的方法简单经济实惠，哼哼，感觉能满足大部分常规检测的需求，但今天我要说的是一个专业的进程守护工具， <strong>Supervisor</strong>，这货在基hub开源，由Python实现，地址 <a href="https://github.com/Supervisor/supervisor">https://github.com/Supervisor/supervisor</a></p>

<hr />

<h2 id="section">安装</h2>
<p>4种方法</p>

<ul>
  <li><code class="highlighter-rouge">pip install supervisor</code>  [常规python安装]</li>
  <li><code class="highlighter-rouge">apt-get install supervisor</code> [Linux系统 ubuntu]</li>
  <li><code class="highlighter-rouge">yum install supervisor</code> [Linux系统 cent]</li>
  <li><code class="highlighter-rouge">brew install supervisor</code> [Mac OS]</li>
</ul>

<hr />

<h2 id="section-1">使用</h2>
<blockquote>
  <p>安装好了supervisor之后，系统主要会多出两个命令，<code class="highlighter-rouge">supervisord</code> <code class="highlighter-rouge">supervisorctl</code>，由于supervisor是类似CS的，<code class="highlighter-rouge">supervisord</code>其实就是服务端，真实的控制着程序运行，而<code class="highlighter-rouge">supervisorctl</code>就是客户端，可以连接服务端进行控制。</p>
</blockquote>

<h3 id="section-2">配置文件</h3>
<p>很贴心，怕你不会写配置，程序帮你写好了一份样板，如下使用
<code class="highlighter-rouge">echo_supervisord_conf</code> 这个命令会输出配置样例，我们把输出写到文件中</p>

<div class="language-shell highlighter-rouge"><pre class="codehilite"><code>echo_supervisord_conf &gt; /usr/local/etc/supervisord.ini
</code></pre></div>

<p>之后<code class="highlighter-rouge">/usr/local/etc/supervisord.ini</code>文件中内容如下，忽略了一些不常用的配置项</p>

<div class="language-ini highlighter-rouge"><pre class="codehilite"><code><span class="c">; Sample supervisor config file.
;
; For more information on the config file, please see:
; http://supervisord.org/configuration.html
;
; Notes:
;  - Shell expansion ("~" or "$HOME") is not supported.  Environment
;    variables can be expanded using this syntax: "%(ENV_HOME)s".
;  - Comments must have a leading space: "a=b ;comment" not "a=b;comment".
</span>
<span class="nn">[unix_http_server]</span>
<span class="py">file</span><span class="p">=</span><span class="s">/usr/local/var/run/supervisor.sock   ; (the path to the socket file)</span>
<span class="c">;chmod=0700                 ; socket file mode (default 0700)
;chown=nobody:nogroup       ; socket file uid:gid owner
;username=user              ; (default is no username (open server))
;password=123               ; (default is no password (open server))
</span>
<span class="c">;[inet_http_server]         ; inet (TCP) server disabled by default
;port=127.0.0.1:9001        ; (ip_address:port specifier, *:port for all iface)
;username=user              ; (default is no username (open server))
;password=123               ; (default is no password (open server))
</span>
<span class="nn">[supervisord]</span>
<span class="py">logfile</span><span class="p">=</span><span class="s">/usr/local/var/log/supervisord.log ; (main log file;default $CWD/supervisord.log)</span>
<span class="py">logfile_maxbytes</span><span class="p">=</span><span class="s">50MB        ; (max main logfile bytes b4 rotation;default 50MB)</span>
<span class="py">logfile_backups</span><span class="p">=</span><span class="s">10           ; (num of main logfile rotation backups;default 10)</span>
<span class="py">loglevel</span><span class="p">=</span><span class="s">info                ; (log level;default info; others: debug,warn,trace)</span>
<span class="py">pidfile</span><span class="p">=</span><span class="s">/usr/local/var/run/supervisord.pid ; (supervisord pidfile;default supervisord.pid)</span>
<span class="py">nodaemon</span><span class="p">=</span><span class="s">false               ; (start in foreground if true;default false)</span>
<span class="py">minfds</span><span class="p">=</span><span class="s">1024                  ; (min. avail startup file descriptors;default 1024)</span>
<span class="py">minprocs</span><span class="p">=</span><span class="s">200                 ; (min. avail process descriptors;default 200)</span>
<span class="c">;umask=022                   ; (process file creation umask;default 022)
;user=chrism                 ; (default is current user, required if root)
;identifier=supervisor       ; (supervisord identifier, default is 'supervisor')
;directory=/tmp              ; (default is not to cd during start)
;nocleanup=true              ; (don't clean up tempfiles at start;default false)
;childlogdir=/tmp            ; ('AUTO' child log dir, default $TEMP)
;environment=KEY="value"     ; (key value pairs to add to environment)
;strip_ansi=false            ; (strip ansi escape codes in logs; def. false)
</span>
<span class="c">; the below section must remain in the config file for RPC
; (supervisorctl/web interface) to work, additional interfaces may be
; added by defining them in separate rpcinterface: sections
</span><span class="nn">[rpcinterface:supervisor]</span>
<span class="py">supervisor.rpcinterface_factory</span> <span class="p">=</span> <span class="s">supervisor.rpcinterface:make_main_rpcinterface</span>

<span class="nn">[supervisorctl]</span>
<span class="py">serverurl</span><span class="p">=</span><span class="s">unix:///usr/local/var/run/supervisor.sock ; use a unix:// URL  for a unix socket</span>
<span class="c">;serverurl=http://127.0.0.1:9001 ; use an http:// url to specify an inet socket
;username=chris              ; should be same as http_username if set
;password=123                ; should be same as http_password if set
;prompt=mysupervisor         ; cmd line prompt (default "supervisor")
;history_file=~/.sc_history  ; use readline history if available
</span>
<span class="c">; The [include] section can just contain the "files" setting.  This
; setting can list multiple files (separated by whitespace or
; newlines).  It can also contain wildcards.  The filenames are
; interpreted as relative to this file.  Included files *cannot*
; include files themselves.
</span>
<span class="c">; ......
</span>
<span class="nn">[include]</span>
<span class="py">files</span> <span class="p">=</span> <span class="s">/usr/local/etc/supervisor.d/*.ini</span>
</code></pre></div>
<p><br />
我们要改的主要是如下部分：</p>

<p><code class="highlighter-rouge">1、浏览器登录管理</code></p>

<div class="language-ini highlighter-rouge"><pre class="codehilite"><code><span class="c">; http服务地址，我们可以在浏览器中进行进程管理
; 去掉注释改成下面的样子即可
</span>
<span class="nn">[inet_http_server]</span>         <span class="c">; inet (TCP) server disabled by default
</span><span class="py">port</span><span class="p">=</span><span class="s">127.0.0.1:9001        ; (ip_address:port specifier, *:port for all iface) ; 服务器监听地址</span>
<span class="py">username</span><span class="p">=</span><span class="s">user              ; (default is no username (open server)) ; 认证登录时的用户名</span>
<span class="py">password</span><span class="p">=</span><span class="s">123               ; (default is no password (open server)) ; 认证登录时的密码</span>
</code></pre></div>

<p><code class="highlighter-rouge">2、运行程序配置</code></p>

<p>可以看到主配置最后include了<code class="highlighter-rouge">supervisor.d</code>文件夹下的<code class="highlighter-rouge">*.ini</code>配置文件，这些被引入的配置其实就是你要启动和守护的程序配置，都要写在这个文件夹里，稍后还会详细说明</p>

<div class="language-ini highlighter-rouge"><pre class="codehilite"><code><span class="nn">[include]</span>
<span class="py">files</span> <span class="p">=</span> <span class="s">/usr/local/etc/supervisor.d/*.ini</span>
</code></pre></div>
<p><br /></p>

<h3 id="supervisor">运行Supervisor主程序</h3>

<div class="language-shell highlighter-rouge"><pre class="codehilite"><code><span class="c"># -c 是指定了配置文件的位置</span>
supervisord -c /usr/local/etc/supervisord.ini
</code></pre></div>

<blockquote>
  <p>如果控制台没有输出，并且ps有supervisor进程在，恭喜，你已经成功启动了！</p>
</blockquote>

<p><br /></p>

<h3 id="section-3">加入你要守护的程序配置</h3>

<p>在<code class="highlighter-rouge">/usr/local/etc/supervisor.d/</code>文件夹中增加你的程序配置，最好的是一个程序一个配置文件，易于管理，像这样</p>

<div class="language-ini highlighter-rouge"><pre class="codehilite"><code><span class="c"># filename: jenkins.ini 控制jenkins进程的配置
</span>
<span class="c"># 程序概述名
</span><span class="nn">[program:jenkins-daemon]</span>

<span class="c"># 程序运行时显示的名字 默认这样即可
</span><span class="py">process_name</span><span class="p">=</span><span class="s">%(program_name)s_%(process_num)02d</span>

<span class="c"># 下面command配置是你的启动命令 如 /usr/bin/php /users/qii404/xxx.php ，绝对路径，不支持$HOME类似的变量
</span><span class="py">command</span><span class="p">=</span><span class="s">/usr/bin/java -jar /Users/qii404/jenkins/jenkins.war</span>

<span class="c"># 该程序是否随着supervisor启动时自动启动
</span><span class="py">autostart</span><span class="p">=</span><span class="s">true</span>

<span class="c"># 挂掉之后自动重新启动
</span><span class="py">autorestart</span><span class="p">=</span><span class="s">true</span>

<span class="c"># 启动用户
</span><span class="py">user</span><span class="p">=</span><span class="s">baidu</span>
<span class="py">numprocs</span><span class="p">=</span><span class="s">1</span>
<span class="py">redirect_stderr</span><span class="p">=</span><span class="s">true</span>

<span class="c"># 程序日志文件
</span><span class="py">stdout_logfile</span><span class="p">=</span><span class="s">/Users/qii404/jenkins_daemon.log</span>
</code></pre></div>

<p><br /></p>

<h3 id="supervisorctl">通过supervisorctl进入控制台</h3>

<ol>
  <li>执行<code class="highlighter-rouge">supervisorctl</code>，根据提示输入你在<code class="highlighter-rouge">/usr/local/etc/supervisord.ini</code>配置中的用户名和密码</li>
  <li>执行<code class="highlighter-rouge">help</code>可以找到你需要的命令列表</li>
  <li>此时，你新加入的jenkins配置还没剩生效，要手动引入，<code class="highlighter-rouge">reread</code>命令重新载入配置</li>
  <li><code class="highlighter-rouge">avail</code>可以看到你加入的程序和状态，如果看到了新加的jenkins，说明配置读取成功</li>
  <li><code class="highlighter-rouge">reload</code>重启程序，此时也会把你的jenkins启动</li>
  <li><code class="highlighter-rouge">status</code>可以看到目前正在运行的程序</li>
</ol>

<div class="language-shell highlighter-rouge"><pre class="codehilite"><code><span class="gp">supervisor&gt; </span>status
jenkins-daemon:jenkins-daemon_00                   RUNNING   pid 45418, uptime 0:10:23
</code></pre></div>

<p>如果看到上面输出，恭喜，你的jenkins已经被启动了~</p>

<p>如果想关闭，在控制台执行<code class="highlighter-rouge">stop jenkins-daemon:jenkins-daemon_00</code>即可</p>

<p><br /></p>

<h3 id="section-4">通过可视化界面控制</h3>
<p>上面配置中还说了一个<code class="highlighter-rouge">port=127.0.0.1:9001 </code>的配置项起始就是为了浏览器控制台准备的，打开浏览器输入<code class="highlighter-rouge">127.0.0.1:9001</code>， 输入刚刚配置中的用户名和密码：</p>

<p><img src="http://ww1.sinaimg.cn/large/71405cably1ff02pth64uj20b2072mxp.jpg" alt="supervisor登录" /></p>

<p><img src="http://ww1.sinaimg.cn/large/71405cably1fezy73f6s5j20rw09rq4s.jpg" alt="supervisor可视化控制台" /></p>

<p>我们可以方便的进行重启、停止等操作，甚至还能监控程序的日志输出哦~</p>


            </div>
        </div>

        <div class="col-md-2">
            <!-- this is COL-MD-22222, for some contents -->
        </div>
    </div>

</div>

<!-- donate -->
<style type="text/css">
    .page-donate{
        margin-top: 20px;
    }
    .page-donate img{
        width: 20%;
        min-width: 100px;
        max-width: 200px;
        margin-right: 10px;
    }
</style>

<div class="page-donate container">
    <hr>
    <p>觉得不错？ 哈哈 感谢赏个键盘磨损钱~（左微信 右支付宝）</p>
    <img class="wechat-donate" src="http://ww1.sinaimg.cn/large/71405cably1fchwyguheej208c08c0up" alt="wechat 8.8" />
    <img class="alipay-donate" src="http://ww1.sinaimg.cn/large/71405cably1fchwyguitnj208c08c0uv" alt="alipay 8.8" />
</div>


<!-- comments -->

    <div class="page-comments container" style="margin-top: 50px;">
    <!-- 来必力City版安装代码 -->
    <div id="lv-container" data-id="city" data-uid="MTAyMC8zMDMyMS82ODc2">
    <script type="text/javascript">
       (function(d, s) {
           var j, e = d.getElementsByTagName(s)[0];

           if (typeof LivereTower === 'function') { return; }

           j = d.createElement(s);
           j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
           j.async = true;

           e.parentNode.insertBefore(j, e);
       })(document, 'script');
    </script>
    <noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
    </div>
    <!-- City版安装代码已完成 -->
</div>



<style type="text/css">
    .footer-contact {
        padding: 15px 0;
        margin-top: 40px;
        text-align: center;
        background-color: #f5f5f5;
        border-top: 1px solid #eee;
    }

    .footer-contact .contact-list {
        margin-bottom: 0;
        padding-left: 0;
    }
    .footer-contact .contact-list li {
        display: inline-block;
        line-height: 1;
    }

    .footer-contact .contact-list li a {
        color: #555;
    }

    .footer-contact .contact-list>li+li:before {
        padding: 0 10px;
        color: #ccc;
        content: "|";
    }

    .footer-contact .contact-list li .fa {
        font-size: 16px;
        margin-right: 3px;
    }
</style>

<footer class="footer-contact">
    <div class="container">
        <ul class="contact-list">
            <li>
                <!-- count pv-->
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1259354296'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s11.cnzz.com/stat.php%3Fid%3D1259354296%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>

            </li>
            <li>
                <a href="mailto:qii404@126.com" title="email">
                    <i class="fa fa-envelope-o"></i> Email To Me
                </a>
            </li>
            <li>
                <a href="http://weibo.com/shiboooo?profile_ftype=1&is_hot=1" title="新浪微博" target="_blank">
                    <i class="fa fa-weibo"></i> 新浪微博：@齐士博
                </a>
            </li>
            <li>
                <a href="https://github.com/qishibo/" title="GitHub" target="_blank">
                    <i class="fa fa-github-square"></i> GitHub
                </a>
            </li>
            <li>
                <i class="fa fa-heart-o" ></i>Powered by Github
            </li>
        </ul>
    </div>
</footer>

<script type="text/javascript" src='https://cdn.bootcss.com/jquery/1.11.3/jquery.min.js'></script>
<script type="text/javascript" src='/assets/js/icon.js'></script>
<script type="text/javascript" src='https://cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js'></script>

<script type="text/javascript">
    $(function(){
        var pre_menu_hight = "";
        if (pre_menu_hight) {
            $('#qii-navbar-collapse li[name="' + pre_menu_hight + '"]').addClass('active');
        }
    })

</script>


<!-- code view highlight -->
<link href="/assets/css/syntax/github.css" rel="stylesheet">





</body>
</html>

