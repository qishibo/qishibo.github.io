<!--
     created by shibo, 2015-04-23 19:23:32.
     Copyright (c) qii404@126.com All Rights Reserved.
     代码何苦为难码农...

                 #####################################################
                 #                                                   #
                 #                       _oo0oo_                     #
                 #                      o8888888o                    #
                 #                      88" . "88                    #
                 #                      (| -_- |)                    #
                 #                      0\  =  /0                    #
                 #                    ___/`---'\___                  #
                 #                  .' \\|     |# '.                 #
                 #                 / \\|||  :  |||# \                #
                 #                / _||||| -:- |||||- \              #
                 #               |   | \\\  -  #/ |   |              #
                 #               | \_|  ''\---/''  |_/ |             #
                 #               \  .-\__  '-'  ___/-. /             #
                 #             ___'. .'  /--.--\  `. .'___           #
                 #          ."" '<  `.___\_<|>_/___.' >' "".         #
                 #         | | :  `- \`.;`\ _ /`;.`/ - ` : | |       #
                 #         \  \ `_.   \_ __\ /__ _/   .-` /  /       #
                 #     =====`-.____`.___ \_____/___.-`___.-'=====    #
                 #                       `=---='                     #
                 #     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~   #
                 #                                                   #
                 #               佛祖保佑         永无BUG              #
                 #                                                   #
                 #####################################################
 -->


<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name=viewport content="width=device-width, initial-scale=1">

    <meta name="keywords" content="nginx, php-fpm, php文件空白">
    <meta name="description" content="nginx下html文件显示正常，php文件显示空白，并且fpm报错 ERROR: failed to retrieve TCP_INFO for socket: Invalid argument (22)">

    <meta name="author" content="齐士博">

    <meta property="og:title" content="nginx php文件显示空白" />
    <meta property="og:type" content="IT Blog" />

    <link rel="shortcut icon" href="/assets/img/icon48.ico">

    <link rel="stylesheet" type="text/css" href="https://cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.bootcss.com/font-awesome/4.2.0/css/font-awesome.min.css">

    

    <title>nginx php文件显示空白</title>

    <style type="text/css">
        .container{
            max-width: 1050px;
        }
        .qii-navbar{
            margin-bottom: 0;
            border-radius: 0;
        }

        .qii-navbar .qii-icon-container{
            width: 53px;
        }

        .qii-navbar .qii-icon-container img{
            margin-top: -8px;
        }

        .container .qii-post-content img{
            width: 80%;
            max-width: 100%;
            margin-top: 8px;
            margin-bottom: 25px;
            border-radius: 8px;
            border:2px solid lightgrey;
        }
        .container .qii-post-content h2,
        .container .qii-post-content h3,
        .container .qii-post-content h4{
            margin-top: 40px;
        }
        table {
            width: 100%;
            max-width: 65em;
            border: 1px solid #dedede;
            margin: 15px auto;
            border-collapse: collapse;
            empty-cells: show;
        }

        table th,
        table td {
          height: 35px;
          border: 1px solid #dedede;
          padding: 0 10px;
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-default navbar-inverse-- qii-navbar ">
        <div class="container">

            <div class="navbar-header">
                <div class="qii-icon-container">
                    <a id="qii-icon-a" class="navbar-brand" href="/"></a>
                </div>

                <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#qii-navbar-collapse" aria-controls="bs-navbar" aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="navbar-collapse collapse" id="qii-navbar-collapse">
                <ul class="nav navbar-nav">
                    <li name="home"><a href="/">Home <span class="sr-only">(current)</span></a></li>
                    <li name="github"><a href="https://github.com/qishibo/" target="blank">Github</a></li>
                    <li name="weibo"><a href="http://weibo.com/shiboooo?profile_ftype=1&is_hot=1" target="blank">Weibo</a></li>
                    <li name="about"><a href="/about">About</a></li>
                </ul>

                <!-- <form class="navbar-form navbar-right" role="search">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search Google">
                    </div>
                    <button type="submit" class="btn btn-default">Search</button>
                </form> -->

            </div>
        </div>
    </nav>

<style type="text/css">
    .qii-top-desc .jumbotron{
        color: white;

        background-image: -webkit-gradient(linear,left top,left bottom,from(#563d7c),to(#6f5499));
        background-image: -webkit-linear-gradient(top,#563d7c 0,#6f5499 100%);
        background-image: -o-linear-gradient(top,#563d7c 0,#6f5499 100%);
        background-image: linear-gradient(to bottom,#563d7c 0,#6f5499 100%);
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#563d7c', endColorstr='#6F5499', GradientType=0);
        background-repeat: repeat-x;

        padding: 30px 0;
    }

    .qii-top-desc .post-title{
        margin-right: 20%;
    }
    .qii-top-desc .post-desc{
        font-size: 22px;
        font-weight: 300;
        margin-right: 20%;
        color: #cdbfe3;
        text-shadow: 0 1px 0 rgba(0,0,0,.1);
    }
    .qii-top-desc .post-date{
        color: #e3ddec;
    }


    .qii-post-content{
        min-height: 45%;
        font-size: 125%;
        line-height: 1.6;
    }
</style>

<header class="qii-top-desc">
    <div class="jumbotron">
        <div class="container">
            <h2 class="post-title">nginx php文件显示空白</h2>
            <p class="post-desc">nginx下html文件显示正常，php文件显示空白，并且fpm报错 ERROR: failed to retrieve TCP_INFO for socket: Invalid argument (22)</p>
            
            <span class="post-date">
                <i class="fa fa-calendar" aria-hidden="true"></i>
                <!-- <span class="glyphicon glyphicon-calendar" aria-hidden="true"></span> -->
                <span>2017-10-14</span>
            </span>
            
        </div>
    </div>
</header>

<!-- content -->
<div class="container">

    <div class="row">
        <div class="col-md-10">
            <div class="qii-post-content">
                <p>今天在bash on windows鼓捣php环境的时候偶然遇到一个坑，就是nginx启动以后，访问index.html可以正常显示，但访问index.php的时候页面一片空白，啥都没有！根据以往在linux下的经验，我的配置完全正确，肯定可行，但在wsl下却跑不通，摸索过程记录如下。</p>

<h2 id="section">复现情景</h2>

<h3 id="nginx">nginx</h3>

<p>正常启动，配置如下（其实就是wsl下apt安装的nginx默认配置），</p>

<blockquote>
  <p>Tips: 贴上在wsl下启动nginx的坑：</p>
</blockquote>

<blockquote>
  <ul>
    <li>fastcig_pass不能像linux下一样使用套接字：<code class="highlighter-rouge">unix:/var/run/php5-fpm.sock</code>，所以只能让fpm监听端口，然后fastcig_pass监听端口即可</li>
    <li>不能使用master模式（master模式即nginx会fork出n多salve进程处理请求，master只做管理），这根wsl下的fork限制有关，所以必须在nginx.conf最外面关闭，可以在<code class="highlighter-rouge">worker_processes</code>后面加上这句 <code class="highlighter-rouge">master_process off;</code></li>
  </ul>
</blockquote>

<div class="language-ini highlighter-rouge"><pre class="codehilite"><code>
<span class="err">location</span> <span class="err">/</span> <span class="err">{</span>
        <span class="c"># First attempt to serve request as file, then
</span>        <span class="c"># as directory, then fall back to displaying a 404.
</span>        <span class="err">try_files</span> <span class="err">$uri</span> <span class="err">$uri/</span> <span class="err">=404</span><span class="c">;
</span>        <span class="c"># Uncomment to enable naxsi on this location
</span>        <span class="c"># include /etc/nginx/naxsi.rules
</span><span class="err">}</span>

<span class="err">location</span> <span class="err">~</span> <span class="err">\.php$</span> <span class="err">{</span>
        <span class="err">fastcgi_split_path_info</span> <span class="err">^(.+\.php)(/.+)$</span><span class="c">;
#       # NOTE: You should have "cgi.fix_pathinfo = 0;" in php.ini
#
#       # With php5-cgi alone:
</span>        <span class="err">fastcgi_pass</span> <span class="err">127.0.0.1:9000</span><span class="c">;
#       # With php5-fpm:
</span>        <span class="c">#fastcgi_pass unix:/var/run/php5-fpm.sock;
</span>        <span class="err">fastcgi_index</span> <span class="err">index.php</span><span class="c">;
</span><span class="err">}</span>

</code></pre></div>

<h3 id="fpm">fpm</h3>

<p>正常启动，监听9000端口</p>

<div class="language-ini highlighter-rouge"><pre class="codehilite"><code><span class="c">; 不使用sock
;listen = /var/run/php5-fpm.sock
</span><span class="py">listen</span> <span class="p">=</span> <span class="s">127.0.0.1:9000</span>
</code></pre></div>

<h3 id="indexphp">index.php</h3>

<p>随便写了个php文件</p>

<div class="language-php highlighter-rouge"><pre class="codehilite"><code><span class="cp">&lt;?php</span>

<span class="nb">phpinfo</span><span class="p">();</span>
</code></pre></div>

<p>结果就是访问index.html文件正常，但访问index.php的时候页面空白，没有返回，查看access日志也是显示200，并没有错误。但如果查看fpm错误日志的话，会得到<code class="highlighter-rouge">ERROR: failed to retrieve TCP_INFO for socket: Invalid argument (22)</code>参数错误的提示。</p>

<h2 id="section-1">解决方法</h2>

<p>在nginx配置中<code class="highlighter-rouge">location ~ \.php$</code>模块里增加如下参数</p>

<div class="language-ini highlighter-rouge"><pre class="codehilite"><code>
<span class="c"># 主要增加如下两行
# 1、引入fastcgi相关参数，用于请求实现了fastcgi协议的守护进程，如fpm
</span><span class="err">include</span> <span class="err">fastcgi_params</span><span class="c">;
# 2、重新定义 fastcgi的 SCRIPT_FILENAME参数， 因为如果要实现fastcgi协议，必须指定 SCRIPT_FILENAME 参数
</span><span class="err">fastcgi_param</span> <span class="err">SCRIPT_FILENAME</span> <span class="err">$document_root$fastcgi_script_name</span><span class="c">;
</span>
<span class="c"># 更改之后为：
</span>
<span class="err">location</span> <span class="err">~</span> <span class="err">\.php$</span> <span class="err">{</span>
        <span class="err">fastcgi_split_path_info</span> <span class="err">^(.+\.php)(/.+)$</span><span class="c">;
#       # NOTE: You should have "cgi.fix_pathinfo = 0;" in php.ini
#
#       # With php5-cgi alone:
</span>        <span class="err">fastcgi_pass</span> <span class="err">127.0.0.1:9000</span><span class="c">;
#       # With php5-fpm:
</span>        <span class="c">#fastcgi_pass unix:/var/run/php5-fpm.sock;
</span>        <span class="err">fastcgi_index</span> <span class="err">index.php</span><span class="c">;
</span>
        <span class="err">include</span> <span class="err">fastcgi_params</span><span class="c">;
</span>        <span class="err">fastcgi_param</span> <span class="err">SCRIPT_FILENAME</span> <span class="err">$document_root$fastcgi_script_name</span><span class="c">;
</span><span class="err">}</span>

</code></pre></div>

<p>重启nginx即可</p>

<h2 id="section-2">问题探究</h2>

<p>在nginx的fastcgi协议模式中，是需要指定运行文件位置的，即<code class="highlighter-rouge">SCRIPT_FILENAME</code>变量，这样fastcgi接口才能知道到底要去执行哪个文件，才能将这个文件路径作为参数正确请求fpm进行处理。然后wsl下默认的nginx配置是没有这句配置的，所以nginx不知道拿哪个文件去请求fpm，这样fpm就会报参数错误,<code class="highlighter-rouge">ERROR: failed to retrieve TCP_INFO for socket: Invalid argument (22)</code>，最终返回给nginx的内容为空白。</p>

<p><code class="highlighter-rouge">SCRIPT_FILENAME</code> 如果不指定，默认值配置在<code class="highlighter-rouge">/etc/nginx/fastcgi_params</code>中，为<code class="highlighter-rouge">$request_filename</code>。我们在配置中使用<code class="highlighter-rouge">include fastcgi_params</code>这其实就是引入fastcgi实现的相关参数，后续nginx通过这些参数才可以去请求实现了fastcgi接口的守护进程，如fpm等。内容如下：</p>

<div class="language-conf highlighter-rouge"><pre class="codehilite"><code><span class="n">fastcgi_param</span>   <span class="n">QUERY_STRING</span>            $<span class="n">query_string</span>;
<span class="n">fastcgi_param</span>   <span class="n">REQUEST_METHOD</span>          $<span class="n">request_method</span>;
<span class="n">fastcgi_param</span>   <span class="n">CONTENT_TYPE</span>            $<span class="n">content_type</span>;
<span class="n">fastcgi_param</span>   <span class="n">CONTENT_LENGTH</span>          $<span class="n">content_length</span>;

<span class="c"># 这句指定了默认 $request_filename 如 index.php
</span><span class="n">fastcgi_param</span>   <span class="n">SCRIPT_FILENAME</span>         $<span class="n">request_filename</span>;
<span class="n">fastcgi_param</span>   <span class="n">SCRIPT_NAME</span>             $<span class="n">fastcgi_script_name</span>;
<span class="n">fastcgi_param</span>   <span class="n">REQUEST_URI</span>             $<span class="n">request_uri</span>;
<span class="n">fastcgi_param</span>   <span class="n">DOCUMENT_URI</span>            $<span class="n">document_uri</span>;
<span class="c"># 这句指定了 $document_root 如 /var/share/nginx/html/
</span><span class="n">fastcgi_param</span>   <span class="n">DOCUMENT_ROOT</span>           $<span class="n">document_root</span>;
<span class="n">fastcgi_param</span>   <span class="n">SERVER_PROTOCOL</span>         $<span class="n">server_protocol</span>;

<span class="n">fastcgi_param</span>   <span class="n">GATEWAY_INTERFACE</span>       <span class="n">CGI</span>/<span class="m">1</span>.<span class="m">1</span>;
<span class="n">fastcgi_param</span>   <span class="n">SERVER_SOFTWARE</span>         <span class="n">nginx</span>/$<span class="n">nginx_version</span>;

<span class="n">fastcgi_param</span>   <span class="n">REMOTE_ADDR</span>             $<span class="n">remote_addr</span>;
<span class="n">fastcgi_param</span>   <span class="n">REMOTE_PORT</span>             $<span class="n">remote_port</span>;
<span class="n">fastcgi_param</span>   <span class="n">SERVER_ADDR</span>             $<span class="n">server_addr</span>;
<span class="n">fastcgi_param</span>   <span class="n">SERVER_PORT</span>             $<span class="n">server_port</span>;
<span class="n">fastcgi_param</span>   <span class="n">SERVER_NAME</span>             $<span class="n">server_name</span>;

<span class="n">fastcgi_param</span>   <span class="n">HTTPS</span>                   $<span class="n">https</span> <span class="n">if_not_empty</span>;

<span class="c"># PHP only, required if PHP was built with --enable-force-cgi-redirect
</span><span class="n">fastcgi_param</span>   <span class="n">REDIRECT_STATUS</span>         <span class="m">200</span>;
</code></pre></div>

<p>所以在不覆盖<code class="highlighter-rouge">SCRIPT_FILENAME</code>参数情况下默认值是<code class="highlighter-rouge">$request_filename</code>，即请求资源的路径，形如 index.php，这类似于相对路径，某些系统上nginx是找不到对应文件的；
然后我们加入的下面这句配置就是手动指定了实现fastcgi协议的 <code class="highlighter-rouge">SCRIPT_FILENAME</code> 参数，并且指定为了绝对路径</p>

<div class="language-conf highlighter-rouge"><pre class="codehilite"><code><span class="n">fastcgi_param</span> <span class="n">SCRIPT_FILENAME</span> $<span class="n">document_root</span>$<span class="n">fastcgi_script_name</span>;
</code></pre></div>

<p>即指定为<code class="highlighter-rouge">$document_root$fastcgi_script_name</code>，最终会被解析为<code class="highlighter-rouge">/usr/share/nginx/html/index.php</code>，这样nginx就会拿着正确的参数去请求fpm，fpm也就能正确返回了。</p>

<hr />

<p>总结起来就是解决很简单，贵在探究，嗯。</p>

            </div>
        </div>

        <div class="col-md-2">
            <!-- this is COL-MD-22222, for some contents -->
        </div>
    </div>

</div>

<!-- donate -->
<style type="text/css">
    .page-donate{
        margin-top: 20px;
    }
    .page-donate img{
        width: 20%;
        min-width: 100px;
        max-width: 200px;
        margin-right: 10px;
    }
</style>

<div class="page-donate container">
    <hr>
    <p>觉得不错？ 哈哈 感谢赏个键盘磨损钱~（左微信 右支付宝）</p>
    <img class="wechat-donate" src="http://ww1.sinaimg.cn/large/71405cably1fchwyguheej208c08c0up" alt="wechat 8.8" />
    <img class="alipay-donate" src="http://ww1.sinaimg.cn/large/71405cably1fchwyguitnj208c08c0uv" alt="alipay 8.8" />
</div>


<!-- comments -->

    <div class="page-comments container" style="margin-top: 50px;">
    <!-- 来必力City版安装代码 -->
    <div id="lv-container" data-id="city" data-uid="MTAyMC8zMDMyMS82ODc2">
    <script type="text/javascript">
       (function(d, s) {
           var j, e = d.getElementsByTagName(s)[0];

           if (typeof LivereTower === 'function') { return; }

           j = d.createElement(s);
           j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
           j.async = true;

           e.parentNode.insertBefore(j, e);
       })(document, 'script');
    </script>
    <noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
    </div>
    <!-- City版安装代码已完成 -->
</div>



<style type="text/css">
    .footer-contact {
        padding: 15px 0;
        margin-top: 40px;
        text-align: center;
        background-color: #f5f5f5;
        border-top: 1px solid #eee;
    }

    .footer-contact .contact-list {
        margin-bottom: 0;
        padding-left: 0;
    }
    .footer-contact .contact-list li {
        display: inline-block;
        line-height: 1;
    }

    .footer-contact .contact-list li a {
        color: #555;
    }

    .footer-contact .contact-list>li+li:before {
        padding: 0 10px;
        color: #ccc;
        content: "|";
    }

    .footer-contact .contact-list li .fa {
        font-size: 16px;
        margin-right: 3px;
    }
</style>

<footer class="footer-contact">
    <div class="container">
        <ul class="contact-list">
            <li>
                <!-- count pv-->
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1259354296'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s11.cnzz.com/stat.php%3Fid%3D1259354296%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>

            </li>
            <li>
                <a href="mailto:qii404@126.com" title="email">
                    <i class="fa fa-envelope-o"></i> Email To Me
                </a>
            </li>
            <li>
                <a href="http://weibo.com/shiboooo?profile_ftype=1&is_hot=1" title="新浪微博" target="_blank">
                    <i class="fa fa-weibo"></i> 新浪微博：@齐士博
                </a>
            </li>
            <li>
                <a href="https://github.com/qishibo/" title="GitHub" target="_blank">
                    <i class="fa fa-github-square"></i> GitHub
                </a>
            </li>
            <li>
                <i class="fa fa-heart-o" ></i>Powered by Github
            </li>
        </ul>
    </div>
</footer>

<script type="text/javascript" src='https://cdn.bootcss.com/jquery/1.11.3/jquery.min.js'></script>
<script type="text/javascript" src='/assets/js/icon.js'></script>
<script type="text/javascript" src='https://cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js'></script>

<script type="text/javascript">
    $(function(){
        var pre_menu_hight = "";
        if (pre_menu_hight) {
            $('#qii-navbar-collapse li[name="' + pre_menu_hight + '"]').addClass('active');
        }
    })

</script>


<!-- code view highlight -->
<link href="/assets/css/syntax/github.css" rel="stylesheet">





</body>
</html>

