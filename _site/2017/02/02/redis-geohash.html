<!--
     created by shibo, 2015-04-23 19:23:32.
     Copyright (c) qii404@126.com All Rights Reserved.
     代码何苦为难码农...

                 #####################################################
                 #                                                   #
                 #                       _oo0oo_                     #
                 #                      o8888888o                    #
                 #                      88" . "88                    #
                 #                      (| -_- |)                    #
                 #                      0\  =  /0                    #
                 #                    ___/`---'\___                  #
                 #                  .' \\|     |# '.                 #
                 #                 / \\|||  :  |||# \                #
                 #                / _||||| -:- |||||- \              #
                 #               |   | \\\  -  #/ |   |              #
                 #               | \_|  ''\---/''  |_/ |             #
                 #               \  .-\__  '-'  ___/-. /             #
                 #             ___'. .'  /--.--\  `. .'___           #
                 #          ."" '<  `.___\_<|>_/___.' >' "".         #
                 #         | | :  `- \`.;`\ _ /`;.`/ - ` : | |       #
                 #         \  \ `_.   \_ __\ /__ _/   .-` /  /       #
                 #     =====`-.____`.___ \_____/___.-`___.-'=====    #
                 #                       `=---='                     #
                 #     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~   #
                 #                                                   #
                 #               佛祖保佑         永无BUG              #
                 #                                                   #
                 #####################################################
 -->


<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name=viewport content="width=device-width, initial-scale=1">

    <meta name="keywords" content="Redis, GeoHash, Redis地理位置, 基于距离的位置推荐">
    <meta name="description" content="Redis 在3.2版本支持了地理位置相关方法，能根据经纬度进行相关推荐计算，找到附近推荐数据">

    <meta name="author" content="齐士博">

    <meta property="og:title" content="Redis GeoHash 地理位置结构" />
    <meta property="og:type" content="IT Blog" />

    <link rel="shortcut icon" href="/assets/img/icon48.ico">

    <link rel="stylesheet" type="text/css" href="https://cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.bootcss.com/font-awesome/4.2.0/css/font-awesome.min.css">

    

    <title>Redis GeoHash 地理位置结构</title>

    <style type="text/css">
        .container{
            max-width: 1050px;
        }
        .qii-navbar{
            margin-bottom: 0;
            border-radius: 0;
        }

        .qii-navbar .qii-icon-container{
            width: 53px;
        }

        .qii-navbar .qii-icon-container img{
            margin-top: -8px;
        }

        .container .qii-post-content img{
            width: 80%;
            max-width: 100%;
            margin-top: 8px;
            margin-bottom: 25px;
            border-radius: 8px;
            border:2px solid lightgrey;
        }
        .container .qii-post-content h2,
        .container .qii-post-content h3,
        .container .qii-post-content h4{
            margin-top: 40px;
        }
        table {
            width: 100%;
            max-width: 65em;
            border: 1px solid #dedede;
            margin: 15px auto;
            border-collapse: collapse;
            empty-cells: show;
        }

        table th,
        table td {
          height: 35px;
          border: 1px solid #dedede;
          padding: 0 10px;
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-default navbar-inverse-- qii-navbar ">
        <div class="container">

            <div class="navbar-header">
                <div class="qii-icon-container">
                    <a id="qii-icon-a" class="navbar-brand" href="/"></a>
                </div>

                <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#qii-navbar-collapse" aria-controls="bs-navbar" aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="navbar-collapse collapse" id="qii-navbar-collapse">
                <ul class="nav navbar-nav">
                    <li name="home"><a href="/">Home <span class="sr-only">(current)</span></a></li>
                    <li name="github"><a href="https://github.com/qishibo/" target="blank">Github</a></li>
                    <li name="weibo"><a href="http://weibo.com/shiboooo?profile_ftype=1&is_hot=1" target="blank">Weibo</a></li>
                    <li name="about"><a href="/about">About</a></li>
                </ul>

                <!-- <form class="navbar-form navbar-right" role="search">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search Google">
                    </div>
                    <button type="submit" class="btn btn-default">Search</button>
                </form> -->

            </div>
        </div>
    </nav>

<style type="text/css">
    .qii-top-desc .jumbotron{
        color: white;

        background-image: -webkit-gradient(linear,left top,left bottom,from(#563d7c),to(#6f5499));
        background-image: -webkit-linear-gradient(top,#563d7c 0,#6f5499 100%);
        background-image: -o-linear-gradient(top,#563d7c 0,#6f5499 100%);
        background-image: linear-gradient(to bottom,#563d7c 0,#6f5499 100%);
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#563d7c', endColorstr='#6F5499', GradientType=0);
        background-repeat: repeat-x;

        padding: 30px 0;
    }

    .qii-top-desc .post-title{
        margin-right: 20%;
    }
    .qii-top-desc .post-desc{
        font-size: 22px;
        font-weight: 300;
        margin-right: 20%;
        color: #cdbfe3;
        text-shadow: 0 1px 0 rgba(0,0,0,.1);
    }
    .qii-top-desc .post-date{
        color: #e3ddec;
    }


    .qii-post-content{
        min-height: 45%;
        font-size: 125%;
        line-height: 1.6;
    }
</style>

<header class="qii-top-desc">
    <div class="jumbotron">
        <div class="container">
            <h2 class="post-title">Redis GeoHash 地理位置结构</h2>
            <p class="post-desc">Redis 在3.2版本支持了地理位置相关方法，能根据经纬度进行相关推荐计算，找到附近推荐数据</p>
            
            <span class="post-date">
                <i class="fa fa-calendar" aria-hidden="true"></i>
                <!-- <span class="glyphicon glyphicon-calendar" aria-hidden="true"></span> -->
                <span>2017-02-02</span>
            </span>
            
        </div>
    </div>
</header>

<!-- content -->
<div class="container">

    <div class="row">
        <div class="col-md-10">
            <div class="qii-post-content">
                <p>Redis在3.2版本悄悄的加入了一个地理位置的功能，哈哈，3.2版本推出已经好久了，一直没有机会尝试一下，今天专门敲数据使用了一番，新增了一共6个方法，看了看相关数据结构和特点，了解了大概的轮廓，今天就来记录一下。</p>

<hr />

<h3 id="geohash">先简单说说GeoHash的原理吧</h3>

<h4 id="section">定义</h4>
<blockquote>
  <p>GeoHash通过切分地图区域的方式将二维的经纬度转换成字符串，切分次数越多字符串越长，表示的范围越精确。字符串相似的表示距离相近，这样可以利用字符串的前缀匹配来查询附近的POI信息。</p>
</blockquote>

<h4 id="section-1">切分方法</h4>
<blockquote>
  <p>切分方法是矩形切分，通过二分法依次缩小范围，所以GeoHash字符串最终定位的是某一个矩形区域，可以看作是一个范围，当范围足够小的时候，就无限接近一个点了</p>
</blockquote>

<h4 id="tips">Tips</h4>
<blockquote>
  <p>但其实没有必要精确到点，矩形刚好反映元素的位置范围，不是具体的位置点，所以能很好的保护隐私。</p>
</blockquote>

<h3 id="section-2">以北海公园为例</h3>

<h4 id="a-">A. 算出纬度序列</h4>

<blockquote>
  <p>地球纬度区间是[-90, 90]， 北海公园的纬度是<code class="highlighter-rouge">39.928167</code>，可以通过下面算法对纬度进行二分逼近编码:</p>
</blockquote>

<ol>
  <li>区间[-90, 90]进行二分为[-90, 0), [0, 90]，称为左右区间，可以确定39.928167属于右区间[0, 90]，给标记为1；</li>
  <li>接着将区间[0, 90]进行二分为 [0, 45), [45, 90]，可以确定39.928167属于左区间 [0, 45)，给标记为0；</li>
  <li>递归上述过程39.928167总是属于某个区间[a, b]。随着每次迭代区间[a, b]总在缩小，并越来越逼近39.928167；</li>
</ol>

<table>
  <thead>
    <tr>
      <th>标记</th>
      <th>左边界值</th>
      <th>中间值</th>
      <th>右边界值</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>-90.000</td>
      <td>0.000 <code class="highlighter-rouge">[hits]</code></td>
      <td>90.000</td>
    </tr>
    <tr>
      <td>0</td>
      <td>0.000 <code class="highlighter-rouge">[hits]</code></td>
      <td>45.000</td>
      <td>90.000</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.000</td>
      <td>22.500 <code class="highlighter-rouge">[hits]</code></td>
      <td>45.000</td>
    </tr>
    <tr>
      <td>1</td>
      <td>22.500</td>
      <td>33.750 <code class="highlighter-rouge">[hits]</code></td>
      <td>45.000</td>
    </tr>
    <tr>
      <td>1</td>
      <td>33.750</td>
      <td>39.375 <code class="highlighter-rouge">[hits]</code></td>
      <td>45.000</td>
    </tr>
  </tbody>
</table>

<blockquote>
  <p>规定：给定的纬度x（39.928167）属于左区间，则记录0，如果属于右区间则记录1，这样随着算法的深入会产生一个序列<code class="highlighter-rouge">10111 00011 ...</code>【递归次数越多，区块划分越细，精度越高，当然数字也就越长】。</p>
</blockquote>

<h4 id="b-11010-01011">B. 同理算出经度序列为<code class="highlighter-rouge">11010 01011</code></h4>

<h4 id="c-211100-11101-00100-01111">C. 奇数位放纬度，偶数位放经度，把2串编码组合生成新串：<code class="highlighter-rouge">11100 11101 00100 01111</code></h4>

<h4 id="d-10-28-29-4-15">D. 然后将新串转化为10进制 <code class="highlighter-rouge">28 29 4 15</code></h4>

<h4 id="e-base3232wx4ggeohash">E. 对十进制数字进行Base32编码，即转换为32进制，得到<code class="highlighter-rouge">wx4g</code>，即为GeoHash字符串</h4>

<hr />

<h2 id="redis--geohash">Redis 中的 GeoHash</h2>

<p>3.2中关于GeoHash新加入的方法有6个</p>

<ol>
  <li><code class="highlighter-rouge">geoadd</code>: 增加地理位置的坐标</li>
  <li><code class="highlighter-rouge">geodist</code>: 获取两个地理位置的距离</li>
  <li><code class="highlighter-rouge">geohash</code>: 获取地理位置的GeoHash值</li>
  <li><code class="highlighter-rouge">geopos</code>: 获取地理位置的坐标</li>
  <li><code class="highlighter-rouge">georadius</code>: 根据给定经纬度坐标获取指定范围内的地理位置集合</li>
  <li><code class="highlighter-rouge">georadiusbymember</code>: 根据给定对象获取该对象范围内的地理位置集合</li>
</ol>

<h3 id="geoadd">GEOADD</h3>

<blockquote>
  <p>把一个对象的经纬度位置添加到库中</p>
</blockquote>

<div class="language-shell highlighter-rouge"><pre class="codehilite"><code>geoadd someKeyYouDecided 43.34567 49.34567 aaa
<span class="c"># (integer) 1</span>

<span class="c"># 一次添加多个</span>
geoadd someKeyYouDecided 43.34567 49.34567 aaa 44.34567 50.34567 bbb
<span class="c"># (integer) 1</span>
</code></pre></div>

<h3 id="geodist">GEODIST</h3>

<blockquote>
  <p>返回两个对象之间的距离</p>
</blockquote>

<div class="language-shell highlighter-rouge"><pre class="codehilite"><code>geodist someKeyYouDecided aaa bbb <span class="o">[</span>可选返回值单位 km千米 mi英里 ft英尺 <span class="o">]</span>
<span class="c"># "132343.9786"</span>
</code></pre></div>

<h3 id="geohash-1">GEOHASH</h3>

<blockquote>
  <p>返回对象对应的GeoHash字符串</p>
</blockquote>

<div class="language-shell highlighter-rouge"><pre class="codehilite"><code>geohash someKeyYouDecided aaa
<span class="c"># 1) "ubybdr57770"</span>

geohash someKeyYouDecided aaa bbb
<span class="c"># 1) "ubybdr57770"</span>
<span class="c"># 2) "ubzw3j5sc10"</span>
</code></pre></div>

<h3 id="geopos">GEOPOS</h3>

<blockquote>
  <p>返回对象的经纬度信息</p>
</blockquote>

<div class="language-shell highlighter-rouge"><pre class="codehilite"><code>geopos someKeyYouDecided aaa
<span class="c"># 1) 1) "43.34566980600357056"</span>
<span class="c">#    2) "49.34566890860142507"</span>
</code></pre></div>

<h3 id="georadius">GEORADIUS</h3>

<blockquote>
  <p>根据经纬度信息，返回周围范围内的其他对象[位置]</p>
</blockquote>

<div class="language-shell highlighter-rouge"><pre class="codehilite"><code><span class="c"># 返回距离经纬度坐标[43.345669, 49.345669] 10000m范围内的其他对象</span>
georadius someKeyYouDecided 43.345669 49.345669 10000 m <span class="o">[</span>WITHDIST WITHCOORD WITHHASH ASC|DESC]
<span class="c"># 1) "aaa"</span>

<span class="c"># 返回距离[43.345669, 49.345669] 经纬度10000m范围内的其他对象 并返回距离</span>
georadius someKeyYouDecided 43.345669 49.345669 10000 m WITHDIST
<span class="c"># 1) 1) "aaa"</span>
<span class="c">#    2) "0.0593"</span>

<span class="c"># 返回距离[43.345669, 49.345669] 经纬度10000m范围内的其他对象 并返回距离、经纬度坐标</span>
georadius someKeyYouDecided 43.345669 49.345669 10000 m WITHDIST WITHCOORD
<span class="c"># 1) 1) "aaa"</span>
<span class="c">#    2) "0.0593"</span>
<span class="c">#    3) 1) "43.34566980600357056"</span>
<span class="c">#       2) "49.34566890860142507"</span>
</code></pre></div>

<h3 id="georadiusbymember">GEORADIUSBYMEMBER</h3>

<blockquote>
  <p>根据对象，返回其范围内的其他对象[位置]</p>
</blockquote>

<div class="language-shell highlighter-rouge"><pre class="codehilite"><code><span class="c"># 返回距离aaa对象1000m范围内的其他对象 包括aaa自己</span>
georadiusbymember someKeyYouDecided aaa  1000 m
<span class="c"># 1) "aaa"</span>

<span class="c"># 返回距离aaa对象1000m范围内的其他对象、距离 包括aaa自己</span>
georadiusbymember someKeyYouDecided aaa  1000 m WITHDIST
<span class="c"># 1) 1) "aaa"</span>
<span class="c">#    2) "0.0000"</span>

<span class="c"># 返回距离aaa对象1000m范围内的其他对象、距离、经纬度坐标 包括aaa自己</span>
georadiusbymember someKeyYouDecided aaa  1000 m WITHDIST WITHCOORD
<span class="c"># 1) 1) "aaa"</span>
<span class="c">#    2) "0.0000"</span>
<span class="c">#    3) 1) "43.34566980600357056"</span>
<span class="c">#       2) "49.34566890860142507"</span>
</code></pre></div>

<hr />

<h2 id="redis-">Redis 实现原理</h2>

<blockquote>
  <p>注意到上述操作中第二个参数都是一个string类型的key，其实Redis是把对应的数据存到了一个<code class="highlighter-rouge">zset</code>有序集合中，其中<code class="highlighter-rouge">someKeyYouDecided</code>就是zset的key，对象名称aaa bbb为zset的member，对象的GeoHash的int值为zset的value，如果你<code class="highlighter-rouge">zrange someKeyYouDecided 0 -1 withscores</code>就会窥探这个zset的真实数据如下</p>
</blockquote>

<div class="language-shell highlighter-rouge"><pre class="codehilite"><code>1<span class="o">)</span> <span class="s2">"aaa"</span>
2<span class="o">)</span> <span class="s2">"3710624661911432"</span>
3<span class="o">)</span> <span class="s2">"bbb"</span>
4<span class="o">)</span> <span class="s2">"3710839010869441"</span>
</code></pre></div>

<p>所以Redis关于地理位置的方法没有删除，因为zrem(key, member)即可实现</p>

<blockquote>
  <p>核心方法<code class="highlighter-rouge">georadius</code> 其实就是根据经纬度换算成GeoHash值，然后根据查询范围换算出上下浮动的range范围，然后<code class="highlighter-rouge">zrangebyscore(GeoHash - range, GeoHash + range)</code>查询附近[上下]的几个对象即可</p>
</blockquote>

<blockquote>
  <p>核心方法<code class="highlighter-rouge">georadiusbymember</code> 同理，根据member得到该对象的GeoHash，后续计算与georadius相同</p>
</blockquote>


            </div>
        </div>

        <div class="col-md-2">
            <!-- this is COL-MD-22222, for some contents -->
        </div>
    </div>

</div>

<!-- donate -->
<style type="text/css">
    .page-donate{
        margin-top: 20px;
    }
    .page-donate img{
        width: 20%;
        min-width: 100px;
        max-width: 200px;
        margin-right: 10px;
    }
</style>

<div class="page-donate container">
    <hr>
    <p>觉得不错？ 哈哈 感谢赏个键盘磨损钱~（左微信 右支付宝）</p>
    <img class="wechat-donate" src="http://ww1.sinaimg.cn/large/71405cably1fchwyguheej208c08c0up" alt="wechat 8.8" />
    <img class="alipay-donate" src="http://ww1.sinaimg.cn/large/71405cably1fchwyguitnj208c08c0uv" alt="alipay 8.8" />
</div>


<!-- comments -->

    <div class="page-comments container" style="margin-top: 50px;">
    <!-- 来必力City版安装代码 -->
    <div id="lv-container" data-id="city" data-uid="MTAyMC8zMDMyMS82ODc2">
    <script type="text/javascript">
       (function(d, s) {
           var j, e = d.getElementsByTagName(s)[0];

           if (typeof LivereTower === 'function') { return; }

           j = d.createElement(s);
           j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
           j.async = true;

           e.parentNode.insertBefore(j, e);
       })(document, 'script');
    </script>
    <noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
    </div>
    <!-- City版安装代码已完成 -->
</div>



<style type="text/css">
    .footer-contact {
        padding: 15px 0;
        margin-top: 40px;
        text-align: center;
        background-color: #f5f5f5;
        border-top: 1px solid #eee;
    }

    .footer-contact .contact-list {
        margin-bottom: 0;
        padding-left: 0;
    }
    .footer-contact .contact-list li {
        display: inline-block;
        line-height: 1;
    }

    .footer-contact .contact-list li a {
        color: #555;
    }

    .footer-contact .contact-list>li+li:before {
        padding: 0 10px;
        color: #ccc;
        content: "|";
    }

    .footer-contact .contact-list li .fa {
        font-size: 16px;
        margin-right: 3px;
    }
</style>

<footer class="footer-contact">
    <div class="container">
        <ul class="contact-list">
            <li>
                <!-- count pv-->
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1259354296'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s11.cnzz.com/stat.php%3Fid%3D1259354296%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>

            </li>
            <li>
                <a href="mailto:qii404@126.com" title="email">
                    <i class="fa fa-envelope-o"></i> Email To Me
                </a>
            </li>
            <li>
                <a href="http://weibo.com/shiboooo?profile_ftype=1&is_hot=1" title="新浪微博" target="_blank">
                    <i class="fa fa-weibo"></i> 新浪微博：@齐士博
                </a>
            </li>
            <li>
                <a href="https://github.com/qishibo/" title="GitHub" target="_blank">
                    <i class="fa fa-github-square"></i> GitHub
                </a>
            </li>
            <li>
                <i class="fa fa-heart-o" ></i>Powered by Github
            </li>
        </ul>
    </div>
</footer>

<script type="text/javascript" src='https://cdn.bootcss.com/jquery/1.11.3/jquery.min.js'></script>
<script type="text/javascript" src='/assets/js/icon.js'></script>
<script type="text/javascript" src='https://cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js'></script>

<script type="text/javascript">
    $(function(){
        var pre_menu_hight = "";
        if (pre_menu_hight) {
            $('#qii-navbar-collapse li[name="' + pre_menu_hight + '"]').addClass('active');
        }
    })

</script>


<!-- code view highlight -->
<link href="/assets/css/syntax/github.css" rel="stylesheet">





</body>
</html>

