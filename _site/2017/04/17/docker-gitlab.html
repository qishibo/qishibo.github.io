<!--
     created by shibo, 2015-04-23 19:23:32.
     Copyright (c) qii404@126.com All Rights Reserved.
     代码何苦为难码农...

                 #####################################################
                 #                                                   #
                 #                       _oo0oo_                     #
                 #                      o8888888o                    #
                 #                      88" . "88                    #
                 #                      (| -_- |)                    #
                 #                      0\  =  /0                    #
                 #                    ___/`---'\___                  #
                 #                  .' \\|     |# '.                 #
                 #                 / \\|||  :  |||# \                #
                 #                / _||||| -:- |||||- \              #
                 #               |   | \\\  -  #/ |   |              #
                 #               | \_|  ''\---/''  |_/ |             #
                 #               \  .-\__  '-'  ___/-. /             #
                 #             ___'. .'  /--.--\  `. .'___           #
                 #          ."" '<  `.___\_<|>_/___.' >' "".         #
                 #         | | :  `- \`.;`\ _ /`;.`/ - ` : | |       #
                 #         \  \ `_.   \_ __\ /__ _/   .-` /  /       #
                 #     =====`-.____`.___ \_____/___.-`___.-'=====    #
                 #                       `=---='                     #
                 #     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~   #
                 #                                                   #
                 #               佛祖保佑         永无BUG              #
                 #                                                   #
                 #####################################################
 -->


<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name=viewport content="width=device-width, initial-scale=1">

    <meta name="keywords" content="Gitlab环境搭建, Gitlab on Docker, Gitlab, docker-compose">
    <meta name="description" content="手动搭建 Gitlab 个人仓库，基于Docker，建议使用工具 docker-compose">

    <meta name="author" content="齐士博">

    <meta property="og:title" content="基于Docker的Gitlab服务器搭建" />
    <meta property="og:type" content="IT Blog" />

    <link rel="shortcut icon" href="/assets/img/icon48.ico">

    <link rel="stylesheet" type="text/css" href="https://cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.bootcss.com/font-awesome/4.2.0/css/font-awesome.min.css">

    

    <title>基于Docker的Gitlab服务器搭建</title>

    <style type="text/css">
        .container{
            max-width: 1050px;
        }
        .qii-navbar{
            margin-bottom: 0;
            border-radius: 0;
        }

        .qii-navbar .qii-icon-container{
            width: 53px;
        }

        .qii-navbar .qii-icon-container img{
            margin-top: -8px;
        }

        .container .qii-post-content img{
            width: 80%;
            max-width: 100%;
            margin-top: 8px;
            margin-bottom: 25px;
            border-radius: 8px;
            border:2px solid lightgrey;
        }
        .container .qii-post-content h2,
        .container .qii-post-content h3,
        .container .qii-post-content h4{
            margin-top: 40px;
        }
        table {
            width: 100%;
            max-width: 65em;
            border: 1px solid #dedede;
            margin: 15px auto;
            border-collapse: collapse;
            empty-cells: show;
        }

        table th,
        table td {
          height: 35px;
          border: 1px solid #dedede;
          padding: 0 10px;
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-default navbar-inverse-- qii-navbar ">
        <div class="container">

            <div class="navbar-header">
                <div class="qii-icon-container">
                    <a id="qii-icon-a" class="navbar-brand" href="/"></a>
                </div>

                <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#qii-navbar-collapse" aria-controls="bs-navbar" aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="navbar-collapse collapse" id="qii-navbar-collapse">
                <ul class="nav navbar-nav">
                    <li name="home"><a href="/">Home <span class="sr-only">(current)</span></a></li>
                    <li name="github"><a href="https://github.com/qishibo/" target="blank">Github</a></li>
                    <li name="weibo"><a href="http://weibo.com/shiboooo?profile_ftype=1&is_hot=1" target="blank">Weibo</a></li>
                    <li name="about"><a href="/about">About</a></li>
                </ul>

                <!-- <form class="navbar-form navbar-right" role="search">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search Google">
                    </div>
                    <button type="submit" class="btn btn-default">Search</button>
                </form> -->

            </div>
        </div>
    </nav>

<style type="text/css">
    .qii-top-desc .jumbotron{
        color: white;

        background-image: -webkit-gradient(linear,left top,left bottom,from(#563d7c),to(#6f5499));
        background-image: -webkit-linear-gradient(top,#563d7c 0,#6f5499 100%);
        background-image: -o-linear-gradient(top,#563d7c 0,#6f5499 100%);
        background-image: linear-gradient(to bottom,#563d7c 0,#6f5499 100%);
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#563d7c', endColorstr='#6F5499', GradientType=0);
        background-repeat: repeat-x;

        padding: 30px 0;
    }

    .qii-top-desc .post-title{
        margin-right: 20%;
    }
    .qii-top-desc .post-desc{
        font-size: 22px;
        font-weight: 300;
        margin-right: 20%;
        color: #cdbfe3;
        text-shadow: 0 1px 0 rgba(0,0,0,.1);
    }
    .qii-top-desc .post-date{
        color: #e3ddec;
    }


    .qii-post-content{
        min-height: 45%;
        font-size: 125%;
        line-height: 1.6;
    }
</style>

<header class="qii-top-desc">
    <div class="jumbotron">
        <div class="container">
            <h2 class="post-title">基于Docker的Gitlab服务器搭建</h2>
            <p class="post-desc">手动搭建 Gitlab 个人仓库，基于Docker，建议使用工具 docker-compose</p>
            
            <span class="post-date">
                <i class="fa fa-calendar" aria-hidden="true"></i>
                <!-- <span class="glyphicon glyphicon-calendar" aria-hidden="true"></span> -->
                <span>2017-04-17</span>
            </span>
            
        </div>
    </div>
</header>

<!-- content -->
<div class="container">

    <div class="row">
        <div class="col-md-10">
            <div class="qii-post-content">
                <p><strong>是不是每个爱折腾的人都有搭建一套自己的Gitlab服务器的冲动~</strong> 哼哼，我就是一个爱折腾的人，曾经也搭建过Gitlab环境，装Redis，装PostgreSQL，装Ruby，装Gitlab，尤其是配置Ruby环境跑Gitlab的时候，卧槽那个坑！不过今天，我再次搭建Gitlab服务，用的是大神已经配置好的Gitlab Docker镜像，哈哈，轻松极了~</p>

<blockquote>
  <p>Tips: Docker环境用的是Mac 下的<a href="https://docs.docker.com/machine/">docker-machine</a>，其他环境如Linux、Windows也有对应的Docker一键环境，很方便的，这里我们重点讨论的不是如何安装Docker，所以这里略过。</p>
</blockquote>

<h2 id="section">概述</h2>
<p>Gitlab的Docker镜像已经由印度大牛做好，地址 <a href="https://github.com/sameersbn/docker-gitlab">https://github.com/sameersbn/docker-gitlab</a>， 其实里面已经说明了如何使用该环境，这里我相当于转述和完善一下而已。</p>

<blockquote>
  <p><em>该镜像做了四件事</em>：</p>

  <ol>
    <li>建立Redis环境 [sameersbn/redis]</li>
    <li>建立PostgreSQL环境 [sameersbn/postgresql]</li>
    <li>建立Ruby环境和Gitlab [sameersbn/gitlab]</li>
    <li>把各个镜像跑起来形成最终环境，开放端口供使用</li>
  </ol>
</blockquote>

<!--
> PS: 上面的redis、postsql、gitlab用的是作者自己的镜像，其实完全也可以换用官方的镜像，只不过他自己的有一些环境变量设置，和该gitlab镜像更加适配，便于我们使用而已。
-->

<h2 id="section-1">实现步骤</h2>

<h3 id="section-2">一、完全手动安装执行</h3>

<blockquote>
  <p>Tips: 不推荐这么使用，因为每次启动之前都要手动启动redis、postgresql等，比较繁琐，容易出错</p>
</blockquote>

<h4 id="redis-">1. 启动 Redis 容器</h4>

<div class="language-shell highlighter-rouge"><pre class="codehilite"><code><span class="c"># 拉取镜像</span>
docker pull sameersbn/redis:latest

<span class="c"># 启动容器</span>
docker run --name gitlab-redis -d  <span class="se">\</span>
  --publish 6379:6379 <span class="se">\</span>
  --volume /srv/docker/redis:/var/lib/redis <span class="se">\</span>
  sameersbn/redis:latest

<span class="c"># 此时访问运行docker的机器ip:6379端口应该正常连接redis</span>
<span class="c"># 我的是 redis-cli -h 192.168.99.100 -p 6379</span>
</code></pre></div>

<h4 id="postresql-">2. 启动 Postresql 容器</h4>

<div class="language-shell highlighter-rouge"><pre class="codehilite"><code><span class="c"># 拉取镜像</span>
docker pull sameersbn/postgresql:latest

<span class="c"># 启动容器</span>
docker run --name gitlab-postgresql -itd <span class="se">\</span>
  --publish 5432:5432 <span class="se">\</span>
  --env <span class="s1">'DB_USER=gitlab'</span> <span class="se">\</span>
  --env <span class="s1">'DB_PASS=password'</span> <span class="se">\</span>
  --env <span class="s1">'DB_NAME=gitlabhq_production'</span> <span class="se">\</span>
  --env <span class="s1">'DB_EXTENSION=pg_trgm'</span> <span class="se">\</span>
  --volume /srv/docker/postgresql:/var/lib/postgresql <span class="se">\</span>
  sameersbn/postgresql:latest

  <span class="c"># 此时访问运行docker的机器ip:5432应该能连接上数据库</span>
  <span class="c"># 我的是 pgcli -h 192.168.99.100 -p 5432 -U gitlab -d gitlabhq_production</span>
</code></pre></div>

<h4 id="gitlab-">3. 启动 Gitlab 容器</h4>

<div class="language-shell highlighter-rouge"><pre class="codehilite"><code><span class="c"># 镜像拉取</span>
docker pull sameersbn/gitlab:latest

<span class="c"># 启动gitlab容器</span>
docker run --name gitlab -d <span class="se">\</span>
    --link gitlab-postgresql:postgresql --link gitlab-redis:redisio <span class="se">\</span>
    --publish 10022:22 --publish 10080:80 <span class="se">\</span>
    --env <span class="s1">'GITLAB_PORT=10080'</span> --env <span class="s1">'GITLAB_SSH_PORT=10022'</span> <span class="se">\</span>
    --env <span class="s1">'GITLAB_SECRETS_DB_KEY_BASE=long-and-random-alpha-numeric-string'</span> <span class="se">\</span>
    --env <span class="s1">'GITLAB_SECRETS_SECRET_KEY_BASE=long-and-random-alpha-numeric-string'</span> <span class="se">\</span>
    --env <span class="s1">'GITLAB_SECRETS_OTP_KEY_BASE=long-and-random-alpha-numeric-string'</span> <span class="se">\</span>
    --volume /srv/docker/gitlab/gitlab:/home/git/data <span class="se">\</span>
    sameersbn/gitlab:latest
</code></pre></div>

<h4 id="section-3">4. 访问10080端口</h4>

<blockquote>
  <p>访问地址 <a href="http://192.168.99.100:10080/">http://192.168.99.100:10080/</a> 理论上可以见到初始化更改密码的界面了，注意ip改成运行docker的机器ip</p>
</blockquote>

<blockquote>
  <p><strong><em><code class="highlighter-rouge">Tips</code></em></strong>: 这里会有个坑，理论上启动了gitlab容器之后就能立即访问的，但实际上却是<code class="highlighter-rouge">502</code>响应，其实是 gitlab 正在执行初始化过程，需要一定的时间，稍等一两分钟再访问即可…</p>
</blockquote>

<hr />

<h3 id="docker-compose">二、使用docker-compose进行启动</h3>

<blockquote>
  <p><strong>强烈推荐</strong>
<br />docker-compose 类似于 node 使用 package.json， php 使用 composer.json 的方式，是通过配置文件管理依赖的方法。具体文档见 <a href="https://docs.docker.com/compose/">https://docs.docker.com/compose/</a>，使用方法如下</p>
</blockquote>

<div class="language-shell highlighter-rouge"><pre class="codehilite"><code><span class="c"># 根据 docker-compose.xml 启动docker 容器</span>
<span class="c"># -c 指定启动的配置文件路径</span>
docker-compose -f docker-compose.xml up
</code></pre></div>

<p>大神已经写好了docker-compose.xml启动文件，我们下载下来</p>

<div class="language-shell highlighter-rouge"><pre class="codehilite"><code>wget https://raw.githubusercontent.com/sameersbn/docker-gitlab/master/docker-compose.yml
</code></pre></div>

<p>该文件内容如下，省略了部分不必要的变量，是能跑起来的最简设置：</p>

<div class="language-shell highlighter-rouge"><pre class="codehilite"><code>version: <span class="s1">'2'</span>

services:
  redis:
    restart: always
    image: sameersbn/redis:latest
    <span class="c"># 如果拉取失败，呵呵，换用下面的阿里云源即可</span>
    <span class="c"># image: registry.cn-hangzhou.aliyuncs.com/acs-sample/redis-sameersbn</span>
    volumes:
    - /srv/docker/gitlab/redis:/var/lib/redis:Z

  postgresql:
    restart: always
    image: sameersbn/postgresql:latest
    <span class="c"># 如果拉取失败，呵呵，换用下面的阿里云源即可</span>
    <span class="c"># image: registry.cn-hangzhou.aliyuncs.com/acs-sample/postgresql-sameersbn</span>
    volumes:
    - /srv/docker/gitlab/postgresql:/var/lib/postgresql:Z
    environment:
    - <span class="nv">DB_USER</span><span class="o">=</span>gitlab
    - <span class="nv">DB_PASS</span><span class="o">=</span>password
    - <span class="nv">DB_NAME</span><span class="o">=</span>gitlabhq_production
    - <span class="nv">DB_EXTENSION</span><span class="o">=</span>pg_trgm

  gitlab:
    restart: always
    image: sameersbn/gitlab:latest
    <span class="c"># 如果拉取失败，呵呵，换用下面的阿里云源即可</span>
    <span class="c"># image: registry.cn-hangzhou.aliyuncs.com/acs-sample/gitlab-sameersbn</span>
    depends_on:
    - redis
    - postgresql
    ports:
    - <span class="s2">"10080:80"</span>
    - <span class="s2">"10022:22"</span>
    volumes:
    - /srv/docker/gitlab/gitlab:/home/git/data:Z
    environment:
    <span class="c"># - DEBUG=false</span>

    <span class="c"># postgresql 配置</span>
    - <span class="nv">DB_ADAPTER</span><span class="o">=</span>postgresql
    - <span class="nv">DB_HOST</span><span class="o">=</span>postgresql
    - <span class="nv">DB_PORT</span><span class="o">=</span>5432
    - <span class="nv">DB_USER</span><span class="o">=</span>gitlab
    - <span class="nv">DB_PASS</span><span class="o">=</span>password
    - <span class="nv">DB_NAME</span><span class="o">=</span>gitlabhq_production

    <span class="c"># redis 配置</span>
    - <span class="nv">REDIS_HOST</span><span class="o">=</span>redis
    - <span class="nv">REDIS_PORT</span><span class="o">=</span>6379

    <span class="c"># 端口配置</span>
    - <span class="nv">GITLAB_PORT</span><span class="o">=</span>10080
    - <span class="nv">GITLAB_SSH_PORT</span><span class="o">=</span>10022

    <span class="c"># CI 所使用的加密密钥</span>
    - <span class="nv">GITLAB_SECRETS_DB_KEY_BASE</span><span class="o">=</span>long-and-random-alphanumeric-string
    <span class="c"># Session 加密密钥</span>
    - <span class="nv">GITLAB_SECRETS_SECRET_KEY_BASE</span><span class="o">=</span>long-and-random-alphanumeric-string
    <span class="c"># 数据库2FA密钥</span>
    - <span class="nv">GITLAB_SECRETS_OTP_KEY_BASE</span><span class="o">=</span>long-and-random-alphanumeric-string

    <span class="c"># restart=always 配置容器退出后自动重启</span>
</code></pre></div>

<h4 id="section-4">开始启动</h4>

<div class="language-shell highlighter-rouge"><pre class="codehilite"><code><span class="c"># 启动配置中的所有依赖容器</span>
docker-compose -f docker-compose.xml up

<span class="c"># 或者加上 -d 参数以后台 daemon 形式运行，但就看不到初始化过程了</span>
<span class="c"># docker-compose -f docker-compose.xml up -d</span>

<span class="c"># 顺利的话就开始执行初始化操作，步骤如下</span>
<span class="c"># 1. postgresql</span>
<span class="c"># 2. redis</span>
<span class="c"># 3. gitlab</span>
</code></pre></div>

<p>控制台会输出当前初始化过程，时间有点长，如果没完成就访问的话会报 <code class="highlighter-rouge">502</code> ，上面也提到过，等待1-2分钟即可</p>

<blockquote>
  <p><strong><em><code class="highlighter-rouge">Tips</code></em></strong>: 启动的时候很可能在镜像拉取的时候失败，原因你知道的，The Grate Wall ，解决方法也很简单，翻墙，或者，将上买呢配置文件中的 image 字段改为注释里写的阿里云源即可。</p>
</blockquote>

<h2 id="section-5">开始体验</h2>

<blockquote>
  <p>访问你装有 Docker 的机器ip:10080端口，我的是<a href="http://192.168.99.100:10080/">http://192.168.99.100:10080/</a>，注意不是127.0.0.1，因为你的Docker环境IP可能是独立的，看看发什么什么吧~</p>
</blockquote>

<p><img src="http://ww1.sinaimg.cn/large/71405cably1ffdzq63rm5j21lg0x2tec.jpg" alt="gitlab success running" /></p>

<p>最后 : 放 Gitlab CE 源码地址 <a href="https://github.com/gitlabhq/gitlabhq">https://github.com/gitlabhq/gitlabhq</a>， 有兴趣的同学可以不用Docker环境，完全自己搭建一套试一试 ಥ_ಥ</p>

            </div>
        </div>

        <div class="col-md-2">
            <!-- this is COL-MD-22222, for some contents -->
        </div>
    </div>

</div>

<!-- donate -->
<style type="text/css">
    .page-donate{
        margin-top: 20px;
    }
    .page-donate img{
        width: 20%;
        min-width: 100px;
        max-width: 200px;
        margin-right: 10px;
    }
</style>

<div class="page-donate container">
    <hr>
    <p>觉得不错？ 哈哈 感谢赏个键盘磨损钱~（左微信 右支付宝）</p>
    <img class="wechat-donate" src="http://ww1.sinaimg.cn/large/71405cably1fchwyguheej208c08c0up" alt="wechat 8.8" />
    <img class="alipay-donate" src="http://ww1.sinaimg.cn/large/71405cably1fchwyguitnj208c08c0uv" alt="alipay 8.8" />
</div>


<!-- comments -->

    <div class="page-comments container" style="margin-top: 50px;">
    <!-- 来必力City版安装代码 -->
    <div id="lv-container" data-id="city" data-uid="MTAyMC8zMDMyMS82ODc2">
    <script type="text/javascript">
       (function(d, s) {
           var j, e = d.getElementsByTagName(s)[0];

           if (typeof LivereTower === 'function') { return; }

           j = d.createElement(s);
           j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
           j.async = true;

           e.parentNode.insertBefore(j, e);
       })(document, 'script');
    </script>
    <noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
    </div>
    <!-- City版安装代码已完成 -->
</div>



<style type="text/css">
    .footer-contact {
        padding: 15px 0;
        margin-top: 40px;
        text-align: center;
        background-color: #f5f5f5;
        border-top: 1px solid #eee;
    }

    .footer-contact .contact-list {
        margin-bottom: 0;
        padding-left: 0;
    }
    .footer-contact .contact-list li {
        display: inline-block;
        line-height: 1;
    }

    .footer-contact .contact-list li a {
        color: #555;
    }

    .footer-contact .contact-list>li+li:before {
        padding: 0 10px;
        color: #ccc;
        content: "|";
    }

    .footer-contact .contact-list li .fa {
        font-size: 16px;
        margin-right: 3px;
    }
</style>

<footer class="footer-contact">
    <div class="container">
        <ul class="contact-list">
            <li>
                <!-- count pv-->
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1259354296'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s11.cnzz.com/stat.php%3Fid%3D1259354296%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>

            </li>
            <li>
                <a href="mailto:qii404@126.com" title="email">
                    <i class="fa fa-envelope-o"></i> Email To Me
                </a>
            </li>
            <li>
                <a href="http://weibo.com/shiboooo?profile_ftype=1&is_hot=1" title="新浪微博" target="_blank">
                    <i class="fa fa-weibo"></i> 新浪微博：@齐士博
                </a>
            </li>
            <li>
                <a href="https://github.com/qishibo/" title="GitHub" target="_blank">
                    <i class="fa fa-github-square"></i> GitHub
                </a>
            </li>
            <li>
                <i class="fa fa-heart-o" ></i>Powered by Github
            </li>
        </ul>
    </div>
</footer>

<script type="text/javascript" src='https://cdn.bootcss.com/jquery/1.11.3/jquery.min.js'></script>
<script type="text/javascript" src='/assets/js/icon.js'></script>
<script type="text/javascript" src='https://cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js'></script>

<script type="text/javascript">
    $(function(){
        var pre_menu_hight = "";
        if (pre_menu_hight) {
            $('#qii-navbar-collapse li[name="' + pre_menu_hight + '"]').addClass('active');
        }
    })

</script>


<!-- code view highlight -->
<link href="/assets/css/syntax/github.css" rel="stylesheet">





</body>
</html>

